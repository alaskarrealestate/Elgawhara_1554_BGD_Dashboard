<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>Ø®Ø±ÙŠØ·Ø© Ù…Ø®Ø·Ø· Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© - Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø³ÙƒØ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2575fc">
<link rel="icon" href="favicon.ico">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:"Segoe UI",Tahoma,Arial;background:#f2f4f7;}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
#topbar{
  position:fixed;
  top:0; left:0; right:0;
  height:72px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 14px;
  z-index:1000;
  box-shadow:0 2px 8px rgba(0,0,0,.15);
  background: linear-gradient(90deg,#6a11cb,#2575fc);
}
#topbar .right-section{
  display:flex;
  align-items:center;
  gap:10px;
  white-space:nowrap;
  overflow:hidden;
}
#topbar .right-section img{height:50px;}
#topbar .subtitle{
  font-family:'Scheherazade New',serif;
  font-size:20px;
  font-weight:700;
  color:#fff;
}
#installBtnTop{
  background:#ff9800;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:6px 12px;
  font-size:14px;
  cursor:pointer;
  flex-shrink:0;
}

/* ===== Ø§Ù„ØªØ®Ø·ÙŠØ· ===== */
#container{display:flex;flex-direction:row-reverse;height:100vh;margin-top:72px;}
#map{flex:1;}
#sidebar{width:360px;background:#fff;padding:12px;overflow-y:auto;box-shadow:-3px 0 10px rgba(0,0,0,.12);}

/* ===== Ø¹Ù†Ø§ØµØ± Ø¬Ø§Ù†Ø¨ÙŠØ© ===== */
.logo-outside{text-align:center;margin-bottom:10px;}
.logo-outside img{width:120px;}
.fixed-box{
  background:#f8fafc;
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
  border:1px solid #e0e0e0;
}
.fixed-box h3{margin:0 0 6px;text-align:center;color:#444;}
.fixed-item{font-size:14px;margin:4px 0;}
.title{font-size:17px;font-weight:bold;text-align:center;margin:10px 0 6px;}

/* ===== Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª ===== */
.sectors{display:flex;gap:6px;}
.sector-btn{
  flex:1;
  background:#e0e0e0;
  border-radius:10px;
  padding:10px;
  text-align:center;
  cursor:pointer;
  font-weight:bold;
}
.sector-btn.active{background:#616161;color:#fff;}
select,button{width:100%;padding:10px;font-size:15px;border-radius:8px;margin-top:8px;}
#clearBtn{background:#c62828;color:#fff;border:none;}

/* ===== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===== */
.stats{background:#f3f6f9;border-radius:10px;padding:10px;margin-top:10px;}
.stat{font-size:14px;margin:4px 0;}
.footer-logo{text-align:center;margin:14px 0;}
.footer-logo img{width:80px;}
.contact-box{text-align:center;}

/* ===== Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø¨Ù„ÙƒØ§Øª ===== */
.leaflet-marker-icon div{
  border:2px solid #fff;
  border-radius:50%;
  width:28px;
  height:28px;
  line-height:28px;
  text-align:center;
  font-weight:bold;
  color:#fff;
  font-size:14px;
  transition: all 0.3s ease;
}
.glow{
  box-shadow:0 0 12px 4px rgba(255,255,255,0.9);
  transform: scale(1.4);
}

/* ===== tooltip ===== */
.leaflet-tooltip.custom-tooltip{
  background:#263238;
  color:#fff;
  border-radius:8px;
  padding:8px;
  font-size:12px;
}

/* ===== Ø¬ÙˆØ§Ù„ ===== */
@media(max-width:768px){
  #container{flex-direction:column-reverse;}
  #sidebar{width:100%;max-height:50vh;}
  #map{height:50vh;}
  #topbar{height:56px;padding:0 10px;}
  #topbar img{height:40px;}
  .subtitle{font-size:16px;}
  #installBtnTop{padding:5px 10px;font-size:12px;}
}
</style>
</head>

<body>
<div id="topbar">
  <button id="installBtnTop">ğŸ“² ØªØ«Ø¨ÙŠØª</button>
  <div class="right-section">
    <img src="logo_alsakar.png" alt="Logo">
    <span class="subtitle">Ù…Ø¬Ù…ÙˆØ¹Ø© ØµØ§Ù„Ø­ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø³ÙƒØ± Ù„Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</span>
  </div>
</div>

<div id="container">
  <div id="sidebar">
    <div class="logo-outside"><img src="logo_jawhara.png" alt="Logo Jawhara"></div>

    <div class="fixed-box">
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø·Ø· Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø©</h3>
      <div class="fixed-item"><b>Ø±Ù‚Ù… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯:</b> 1554</div>
      <div class="fixed-item" id="fx1"></div>
      <div class="fixed-item" id="fx2"></div>
      <div class="fixed-item" id="fx3"></div>
      <div class="fixed-item" id="fx4"></div>
      <div class="fixed-item" id="fx5"></div>
    </div>

    <div class="title">Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</div>
    <div class="sectors">
      <div class="sector-btn" data-sector="B">B</div>
      <div class="sector-btn" data-sector="G">G</div>
      <div class="sector-btn" data-sector="D">D</div>
    </div>

    <div class="title">Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ùƒ</div>
    <select id="blockSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù„Ùƒ</option></select>
    <button id="clearBtn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>

    <div class="stats">
      <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
      <div class="stat" id="stat1"></div>
      <div class="stat" id="stat2"></div>
      <div class="stat" id="stat3"></div>
      <div class="stat" id="stat4"></div>
      <div class="stat" id="stat5"></div>
    </div>

    <div class="footer-logo"><img src="logo_alsakar.png" alt="Logo Footer"></div>
    <div class="fixed-box contact-box">
      <h3>Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±</h3>
      <div class="fixed-item">ğŸ“ 0505100124</div>
      <div class="fixed-item">ğŸ“ 0555101067</div>
      <div class="fixed-item">âœ‰ alaskar_group@yahoo.com</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
let deferredPrompt;
const installBtnTop=document.getElementById('installBtnTop');
installBtnTop.onclick=async()=>{
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  installBtnTop.style.display='none';
};
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  installBtnTop.style.display='block';
});

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}

const map=L.map('map').setView([24.17556,47.27167],15);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);

const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSa4Qk4RNs7zPDG6RWfjFXPLGWzSHsjpc_YNic199mkg7HMItxbzfzwT0Y_KYd-zWucMCg-y2Ac06QW/pub?output=csv";
const fmt=n=>Number(n).toLocaleString('en-US',{minimumFractionDigits:2});
const tr=v=>v==='commercial'?'ØªØ¬Ø§Ø±ÙŠ':'Ø³ÙƒÙ†ÙŠ';
const STATUS_LABEL={available:"Ù…ØªØ§Ø­",reserved:"Ù…Ø­Ø¬ÙˆØ²",sold:"ØªÙ… Ø§Ù„Ø¨ÙŠØ¹"};
const TYPE_COLOR={commercial:"#2e7d32",residential:"#1976d2"};

let all=[],currentSector=null,currentBlock=null;
const blockSelect=document.getElementById('blockSelect');

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
Papa.parse(SHEET_URL,{download:true,header:true,complete:res=>{
  let area=0,bc=0,br=0,pc=0,pr=0;

  res.data.forEach(d=>{
    if(!d.lat||!d.lng) return;
    area+=+d.area;
    d.usage==='commercial'?(bc++,pc+=+d.plots_count):(br++,pr+=+d.plots_count);

    const color=TYPE_COLOR[d.usage]||"#607d8b";
    const icon=L.divIcon({
      html:`<div style="background:${color};border:2px solid #fff;color:#fff;">${d.block}</div>`,
      className:'',iconSize:[28,28],iconAnchor:[14,14]
    });

    const marker=L.marker([+d.lat,+d.lng],{icon}).bindTooltip(
      `<b>Ø§Ù„Ù‚Ø·Ø§Ø¹:</b> ${d.sector}<br><b>Ø§Ù„Ø¨Ù„Ùƒ:</b> ${d.block}<br><b>Ø§Ù„Ù†ÙˆØ¹:</b> ${tr(d.usage)}<br><b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b> ${fmt(d.area)} Ù…Â²<br><b>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹:</b> ${d.plots_count}<br><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${STATUS_LABEL[d.status]||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}`,
      {sticky:true,className:'custom-tooltip'}
    );

    marker.on('click', function(){
      const div = this._icon.querySelector('div');
      div.classList.add('glow');
      this.openTooltip();
      map.flyTo(this.getLatLng(),18,{duration:1.2});
      setTimeout(()=>div.classList.remove('glow'),1000);
    });

    marker._visible=true;
    all.push({marker,data:d});

    if(![...blockSelect.options].some(o=>o.value===d.block))
      blockSelect.innerHTML+=`<option value="${d.block}">${d.block}</option>`;

    marker.addTo(map);
  });

  fx1.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„ÙƒØ§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${bc}`;
  fx2.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„ÙƒØ§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©: ${br}`;
  fx3.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${pc}`;
  fx4.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø³ÙƒÙ†ÙŠØ©: ${pr}`;
  fx5.innerHTML=`Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${fmt(area)} Ù…Â²`;
}});

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª: Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙÙ‚Ø·
function update(){
  all.forEach(o=>{
    const visible = (!currentSector || o.data.sector===currentSector) && (!currentBlock || o.data.block===currentBlock);
    if(visible && !o._visible){
      o.marker.addTo(map);
      o._visible=true;
    } else if(!visible && o._visible){
      map.removeLayer(o.marker);
      o._visible=false;
    }
  });

  if(currentBlock){
    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²ÙˆÙ… Ù„ÙŠØ¨Ø­Ø« Ø¶Ù…Ù† Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù…Ø­Ø¯Ø¯ Ø£Ùˆ Ø£ÙŠ Ù‚Ø·Ø§Ø¹ Ø¢Ø®Ø±
    const dObj = all.find(o => o.data.block === currentBlock && (!currentSector || o.data.sector === currentSector));
    if(dObj){
      const d = dObj.data;
      stat1.innerHTML=`<b>Ø§Ù„Ù‚Ø·Ø§Ø¹:</b> ${d.sector}`;
      stat2.innerHTML=`<b>Ø§Ù„Ø¨Ù„Ùƒ:</b> ${d.block} (${tr(d.usage)})`;
      stat3.innerHTML=`<b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${STATUS_LABEL[d.status]}`;
      stat4.innerHTML=`<b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b> ${fmt(d.area)} Ù…Â²`;
      stat5.innerHTML=`<b>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹:</b> ${d.plots_count}`;
      map.flyTo([+d.lat,+d.lng],18,{duration:1.2});
    }
  } else {
    stat1.innerHTML=stat2.innerHTML=stat3.innerHTML=stat4.innerHTML=stat5.innerHTML='';
    map.setView([24.17556,47.27167],15);
  }
}

document.querySelectorAll('.sector-btn').forEach(b=>{b.onclick=()=>{
  document.querySelectorAll('.sector-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  currentSector=b.dataset.sector;
  currentBlock=null;
  update();
}});
blockSelect.onchange=e=>{currentBlock=e.target.value||null;update();};
clearBtn.onclick=()=>{currentSector=currentBlock=null;blockSelect.value='';document.querySelectorAll('.sector-btn').forEach(x=>x.classList.remove('active'));update();};
</script>
</body>
</html>
