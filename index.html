<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>Ø®Ø±ÙŠØ·Ø© Ù…Ø®Ø·Ø· Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© - Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø³ÙƒØ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2575fc">
<link rel="icon" href="favicon.ico">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:"Segoe UI",Tahoma,Arial;background:#f2f4f7;}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
#topbar{
  position:fixed;
  top:0; left:0; right:0;
  height:72px;
  display:flex;
  align-items:center;
  justify-content:flex-start; /* Ù†Ù‚Ù„ Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„Ø§Ø³Ù… Ù„Ù„Ø¬Ù‡Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ */
  padding:0 14px;
  z-index:1000;
  box-shadow:0 2px 8px rgba(0,0,0,.15);
  background: linear-gradient(90deg,#6a11cb,#2575fc);
}
#topbar .left-section{
  display:flex;
  align-items:center;
  gap:10px;
  white-space:nowrap;
  overflow:hidden;
}
#topbar img{height:50px;}
#topbar .subtitle{
  font-family:'Scheherazade New',serif;
  font-size:20px;
  font-weight:700;
  color:#fff;
}

/* ===== Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ø§Ø¦Ù… ===== */
#installFab{
  position:fixed;
  bottom:24px;
  left:24px;
  z-index:2000;
  display:none;
  background:linear-gradient(135deg,#ff9800,#f57c00);
  color:#fff;
  border:none;
  border-radius:30px;
  padding:14px 22px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,.3);
}
#installFab:hover{opacity:.95;}

/* ===== Ø§Ù„ØªØ®Ø·ÙŠØ· ===== */
#container{display:flex;flex-direction:row-reverse;height:100vh;margin-top:72px;}
#map{flex:1;}
#sidebar{width:360px;background:#fff;padding:12px;overflow-y:auto;box-shadow:-3px 0 10px rgba(0,0,0,.12);}

/* ===== Ø¹Ù†Ø§ØµØ± Ø¬Ø§Ù†Ø¨ÙŠØ© ===== */
.logo-outside{text-align:center;margin-bottom:10px;}
.logo-outside img{width:120px;}
.fixed-box{
  background:#f8fafc;
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
  border:1px solid #e0e0e0;
}
.fixed-box h3{margin:0 0 6px;text-align:center;color:#444;}
.fixed-item{font-size:14px;margin:4px 0;}
.title{font-size:17px;font-weight:bold;text-align:center;margin:10px 0 6px;}

/* ===== Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª ===== */
.sectors{display:flex;gap:6px;}
.sector-btn{
  flex:1;
  background:#e0e0e0;
  border-radius:10px;
  padding:10px;
  text-align:center;
  cursor:pointer;
  font-weight:bold;
}
.sector-btn.active{background:#616161;color:#fff;}
select,button{width:100%;padding:10px;font-size:15px;border-radius:8px;margin-top:8px;}
#clearBtn{background:#c62828;color:#fff;border:none;}

/* ===== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===== */
:root{
  --stats-bg: linear-gradient(180deg,#eef4ff,#dbeafe);
  --stats-border:#c7d2fe;
  --stats-card:#ffffff;
  --stats-text:#1e293b;
  --sector-accent:#2563eb;
  --block-accent:#16a34a;
}

.stats{
  background:var(--stats-bg);
  border-radius:16px;
  padding:12px;
  margin-top:12px;
  border:1px solid var(--stats-border);
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  color:var(--stats-text);
  transition:all .3s ease;
}
.stats.collapsed{
  padding:8px 12px;
}
.stats.collapsed .stat{display:none;}
.stats.collapsed .title{margin:0;}

.stats .title{
  font-size:16px;
  font-weight:700;
  text-align:center;
  color:#1e3a8a;
}

.stat{
  background:var(--stats-card);
  border-radius:12px;
  padding:10px 12px;
  margin:6px 0;
  font-size:14px;
  line-height:1.6;
  border:1px solid #e5e7eb;
}

.stat.sector{
  background:#e0e7ff;
  border-color:#c7d2fe;
  font-weight:700;
  color:#1e3a8a;
}

.stat.block{
  background:#ecfdf5;
  border-color:#bbf7d0;
  font-weight:700;
  color:#065f46;
}

.footer-logo{text-align:center;margin:14px 0;}
.footer-logo img{width:80px;}
.contact-box{text-align:center;}

/* ===== Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø¨Ù„ÙƒØ§Øª ===== */
.leaflet-marker-icon div{
  border:2px solid #fff;
  border-radius:50%;
  width:28px;
  height:28px;
  line-height:28px;
  text-align:center;
  font-weight:bold;
  color:#fff;
  font-size:14px;
  transition: all 0.3s ease;
}
.glow{
  box-shadow:0 0 12px 4px rgba(255,255,255,0.9);
  transform: scale(1.4);
}

/* ===== tooltip ===== */
.leaflet-tooltip.custom-tooltip{
  background:#263238;
  color:#fff;
  border-radius:8px;
  padding:8px;
  font-size:12px;
}

/* ===== Ø¬ÙˆØ§Ù„ ===== */
@media(max-width:768px){
  #container{flex-direction:column-reverse;}
  #sidebar{width:100%;max-height:50vh;}
  #map{height:50vh;}
  #topbar{height:56px;padding:0 10px;}
  #topbar img{height:40px;}
  .subtitle{font-size:16px;}
  #installFab{bottom:16px;left:16px;padding:12px 18px;font-size:13px;}
}
</style>
</head>

<body>
<div id="topbar">
  <div class="left-section">
    <img src="logo_alsakar.png" alt="Logo">
    <span class="subtitle">Ù…Ø¬Ù…ÙˆØ¹Ø© ØµØ§Ù„Ø­ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø³ÙƒØ± Ù„Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</span>
  </div>
</div>

<button id="installFab">ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>

<div id="container">
  <div id="sidebar">
    <div class="logo-outside"><img src="logo_jawhara.png" alt="Logo Jawhara"></div>

    <div class="fixed-box">
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø·Ø· Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø©</h3>
      <div class="fixed-item"><b>Ø±Ù‚Ù… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯:</b> 1554</div>
      <div class="fixed-item" id="fx1"></div>
      <div class="fixed-item" id="fx2"></div>
      <div class="fixed-item" id="fx3"></div>
      <div class="fixed-item" id="fx4"></div>
      <div class="fixed-item" id="fx5"></div>
    </div>

    <div class="title">Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</div>
    <div class="sectors">
      <div class="sector-btn" data-sector="B">B</div>
      <div class="sector-btn" data-sector="G">G</div>
      <div class="sector-btn" data-sector="D">D</div>
    </div>

    <div class="title">Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ùƒ</div>
    <select id="blockSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù„Ùƒ</option></select>
    <button id="clearBtn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>

    <div class="stats collapsed">
      <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
      <div class="stat" id="stat1"></div>
      <div class="stat" id="stat2"></div>
      <div class="stat" id="stat3"></div>
      <div class="stat" id="stat4"></div>
      <div class="stat" id="stat5"></div>
      <div class="stat" id="stat6"></div>
    </div>

    <div class="footer-logo"><img src="logo_alsakar.png" alt="Logo Footer"></div>
    <div class="fixed-box contact-box">
      <h3>Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±</h3>
      <div class="fixed-item">ğŸ“ 0505100124</div>
      <div class="fixed-item">ğŸ“ 0555101067</div>
      <div class="fixed-item">âœ‰ alaskar_group@yahoo.com</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ===== PWA Install Logic (Ù…Ø³ØªÙ‚Ø± ÙˆÙ†Ù‡Ø§Ø¦ÙŠ) ===== */
let deferredPrompt=null;
const installFab=document.getElementById('installFab');

function isInstalled(){
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true;
}

function refreshInstallButton(){
  if(isInstalled()){
    installFab.style.display='none';
  }
}

refreshInstallButton();

window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  if(!isInstalled()) installFab.style.display='block';
});

installFab.addEventListener('click',async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const choice=await deferredPrompt.userChoice;
  if(choice.outcome==='accepted') installFab.style.display='none';
  deferredPrompt=null;
});

window.addEventListener('appinstalled',()=>{
  installFab.style.display='none';
});

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}

/* ===== ÙƒÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (ÙƒÙ…Ø§ ÙƒØ§Ù† Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±) ===== */
const map=L.map('map').setView([24.17556,47.27167],15);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);

const SHEET_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSa4Qk4RNs7zPDG6RWfjFXPLGWzSHsjpc_YNic199mkg7HMItxbzfzwT0Y_KYd-zWucMCg-y2Ac06QW/pub?output=csv";
const fmt=n=>Number(n).toLocaleString('en-US',{minimumFractionDigits:2});
const tr=v=>v==='commercial'?'ØªØ¬Ø§Ø±ÙŠ':'Ø³ÙƒÙ†ÙŠ';
const STATUS_LABEL={available:"Ù…ØªØ§Ø­",reserved:"Ù…Ø­Ø¬ÙˆØ²",sold:"ØªÙ… Ø§Ù„Ø¨ÙŠØ¹"};
const TYPE_COLOR={commercial:"#2e7d32",residential:"#1976d2"};

let all=[],currentSector=null,currentBlock=null;
const blockSelect=document.getElementById('blockSelect');

Papa.parse(SHEET_URL,{download:true,header:true,complete:res=>{
  let area=0,bc=0,br=0,pc=0,pr=0;

  res.data.forEach(d=>{
    if(!d.lat||!d.lng) return;
    area+=+d.area;
    d.usage==='commercial'?(bc++,pc+=+d.plots_count):(br++,pr+=+d.plots_count);

    const color=TYPE_COLOR[d.usage]||"#607d8b";
    const icon=L.divIcon({
      html:`<div style="background:${color};border:2px solid #fff;color:#fff;">${d.block}</div>`,
      className:'',iconSize:[28,28],iconAnchor:[14,14]
    });

    const marker=L.marker([+d.lat,+d.lng],{icon}).bindTooltip(
      `<b>Ø§Ù„Ù‚Ø·Ø§Ø¹:</b> ${d.sector}<br><b>Ø§Ù„Ø¨Ù„Ùƒ:</b> ${d.block}<br><b>Ø§Ù„Ù†ÙˆØ¹:</b> ${tr(d.usage)}<br><b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b> ${fmt(d.area)} Ù…Â²<br><b>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹:</b> ${d.plots_count}<br><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${STATUS_LABEL[d.status]||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}`,
      {sticky:true,className:'custom-tooltip'}
    );

    marker.on('click',function(){
      const div=this._icon.querySelector('div');
      div.classList.add('glow');
      this.openTooltip();
      map.flyTo(this.getLatLng(),18,{duration:1.2});
      setTimeout(()=>div.classList.remove('glow'),1000);
    });

    marker._visible=true;
    all.push({marker,data:d});

    if(![...blockSelect.options].some(o=>o.value===d.block)){
      blockSelect.innerHTML+=`<option value="${d.block}">${d.block}</option>`;
    }

    marker.addTo(map);
  });

  fx1.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„ÙƒØ§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${bc}`;
  fx2.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„ÙƒØ§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©: ${br}`;
  fx3.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${pc}`;
  fx4.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø³ÙƒÙ†ÙŠØ©: ${pr}`;
  fx5.innerHTML=`Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${fmt(area)} Ù…Â²`;
}});

function update(){
  let sc=0,sr=0,pc=0,pr=0,area=0;
  const statsBox=document.querySelector('.stats');

  all.forEach(o=>{
    const visible = (!currentSector || o.data.sector===currentSector) && (!currentBlock || o.data.block===currentBlock);
    if(visible && !o._visible){
      o.marker.addTo(map); o._visible=true;
    } else if(!visible && o._visible){
      map.removeLayer(o.marker); o._visible=false;
    }

    if(currentSector && o.data.sector===currentSector){
      area+=+o.data.area;
      if(o.data.usage==='commercial'){sc++;pc+=+o.data.plots_count;}
      else{sr++;pr+=+o.data.plots_count;}
    }
  });

  if(currentBlock){
    statsBox.classList.remove('collapsed');
    const dObj = all.find(o=>o.data.block===currentBlock && (!currentSector || o.data.sector===currentSector));
    if(dObj){
      const d=dObj.data;
      stat1.className='stat sector';
      stat2.className='stat block';
      stat3.className=stat4.className=stat5.className='stat';
      stat1.innerHTML=`Ø§Ù„Ù‚Ø·Ø§Ø¹: ${d.sector}`;
      stat2.innerHTML=`Ø§Ù„Ø¨Ù„Ùƒ: ${d.block} (${tr(d.usage)})`;
      stat3.innerHTML=`Ø§Ù„Ø­Ø§Ù„Ø©: ${STATUS_LABEL[d.status]}`;
      stat4.innerHTML=`Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${fmt(d.area)} Ù…Â²`;
      stat5.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹: ${d.plots_count}`;
      map.flyTo([+d.lat,+d.lng],18,{duration:1.2});
    }
  } else if(currentSector){
    statsBox.classList.remove('collapsed');
    stat1.className='stat sector';
    stat2.className=stat3.className=stat4.className=stat5.className='stat';
    stat1.innerHTML=`Ø§Ù„Ù‚Ø·Ø§Ø¹: ${currentSector}`;
    stat2.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„ÙƒØ§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${sc}`;
    stat3.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„ÙƒØ§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©: ${sr}`;
    stat4.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${pc}`;
    stat5.innerHTML=`Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø³ÙƒÙ†ÙŠØ©: ${pr}`;
    stat6.innerHTML=`Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${fmt(area)} Ù…Â²`;
    map.setView([24.17556,47.27167],15);
  } else {
    statsBox.classList.add('collapsed');
    stat1.innerHTML=stat2.innerHTML=stat3.innerHTML=stat4.innerHTML=stat5.innerHTML=stat6.innerHTML='';
    map.setView([24.17556,47.27167],15);
  }
}

document.querySelectorAll('.sector-btn').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.sector-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    currentSector=b.dataset.sector;
    currentBlock=null;
    update();
  };
});

blockSelect.onchange=e=>{currentBlock=e.target.value||null;update();};
clearBtn.onclick=()=>{
  currentSector=currentBlock=null;
  blockSelect.value='';
  document.querySelectorAll('.sector-btn').forEach(x=>x.classList.remove('active'));
  update();
};
</script>
</body>
</html>
